name: Dart Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        sdk: [3.6.0]

    steps:
      # 1) Faz checkout do repositório
      - name: Check out repository
        uses: actions/checkout@v2

      # 2) Gera os certificados SSL (CA + servidor)
      - name: Generate SSL certificates
        run: |
          mkdir certs

          # Gera CA autoassinada (opcional para teste)
          openssl req -x509 -newkey rsa:2048 -nodes \
            -keyout certs/ca-key.pem \
            -out certs/ca-cert.pem \
            -days 365 \
            -subj "/C=BR/ST=Rio de Janeiro/L=Rio das Ostras/O=PMRO/OU=ASCOMTI/CN=MyTestCA"

          # Gera chave e certificado de servidor autoassinado
          openssl req -newkey rsa:2048 -nodes \
            -keyout certs/server-key.pem \
            -out certs/server-req.pem \
            -subj "/C=BR/ST=Rio de Janeiro/L=Rio das Ostras/O=PMRO/OU=ASCOMTI/CN=localhost"
          openssl x509 -req \
            -in certs/server-req.pem \
            -CA certs/ca-cert.pem \
            -CAkey certs/ca-key.pem \
            -CAcreateserial \
            -out certs/server-cert.pem \
            -days 365

      # 3) Cria um arquivo de configuração do MariaDB com diretivas de SSL
      - name: Create MariaDB config
        run: |
          echo "[mysqld]" > my.cnf
          echo "ssl_ca=$PWD/certs/ca-cert.pem" >> my.cnf
          echo "ssl_cert=$PWD/certs/server-cert.pem" >> my.cnf
          echo "ssl_key=$PWD/certs/server-key.pem" >> my.cnf
          echo "bind-address=0.0.0.0" >> my.cnf

      # 4) Sobe o MariaDB usando o action (sem parâmetro my_cnf, pois não é suportado)
      - name: Setup MariaDB
        uses: ankane/setup-mariadb@v1
        with:
          mariadb-version: "10.11"
          database: banco_teste

      # 5) Copia o arquivo my.cnf para o diretório de configuração do MariaDB e reinicia o serviço para habilitar SSL
      - name: Configure MariaDB for SSL
        run: |
          sudo cp my.cnf /etc/mysql/mariadb.conf.d/ssl.cnf
          sudo systemctl restart mariadb

      # 6) Verifica se o MariaDB subiu com SSL habilitado
      - name: Verify MariaDB Installation
        run: |
          mysql --version
          mysql -u root -e 'SELECT VERSION()'
          mysql -u root -e 'SHOW VARIABLES LIKE "have_ssl"'

      # 7) Cria o usuário e concede privilégios
      - name: Configure MySQL User
        run: |
          mysql -u root -e "CREATE USER IF NOT EXISTS 'dart'@'%' IDENTIFIED BY 'dart';"
          mysql -u root -e "GRANT ALL PRIVILEGES ON *.* TO 'dart'@'%' WITH GRANT OPTION;"
          mysql -u root -e "FLUSH PRIVILEGES;"

      # 8) Instala o Dart
      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1.3
        with:
          sdk: ${{ matrix.sdk }}

      # 9) Instala as dependências
      - name: Install Dart Dependencies
        run: dart pub get

      # 10) Roda os testes
      - name: Run Dart Tests
        run: dart run test --concurrency 1 --chain-stack-traces --platform vm
