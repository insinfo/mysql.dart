name: Dart Testing

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        sdk: [3.6.0]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup MariaDB
        uses: ankane/setup-mariadb@v1
        with:
          mariadb-version: "10.11"
          database: banco_teste

      - name: Verify MariaDB Installation
        run: |
          mysql --version
          mysql -e 'SELECT VERSION()' -u root
          mysql -e 'SELECT CURRENT_USER()' -u root
          mysql -e "SHOW VARIABLES LIKE 'socket'"

      - name: Verify Database Creation
        run: mysql -D banco_teste -e 'SELECT DATABASE()'

      - name: Configure MySQL User
        run: |
          mysql -e "CREATE USER IF NOT EXISTS 'dart'@'%' IDENTIFIED BY 'dart';" -u root
          mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'dart'@'%' WITH GRANT OPTION;" -u root
          mysql -e "FLUSH PRIVILEGES;" -u root

      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1.3
        with:
          sdk: ${{ matrix.sdk }}

      - name: Install Dart Dependencies
        run: dart pub get

      - name: Run Dart Tests
        run: dart run test --concurrency 1 --chain-stack-traces --platform vm
